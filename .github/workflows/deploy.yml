name: Deploy Mara Command Center

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: ğŸ“¦ Checkout Source Code
        uses: actions/checkout@v4

      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ”¨ Build Docker Image
        run: |
          echo "Building Docker image..."
          docker build -t xxfall3nxx/mara-command-center:latest .
          echo "âœ… Build complete"

      - name: ğŸ“¤ Push to Docker Hub
        run: |
          echo "Pushing image to Docker Hub..."
          docker push xxfall3nxx/mara-command-center:latest
          echo "âœ… Image published"

  deploy:
    needs: build
    runs-on: self-hosted
    steps:
      - name: ğŸ”§ Prepare Docker Service
        run: |
          echo "Starting Docker service..."
          sudo systemctl start docker
          sudo chmod 666 /var/run/docker.sock
          echo "âœ… Docker service ready"

      - name: ğŸ—‘ï¸ Cleanup Old Deployment
        run: |
          echo "Removing old container..."
          docker rm -f mara-command || echo "No old container to remove"
          echo "Removing old image..."
          docker rmi -f xxfall3nxx/mara-command-center:latest || echo "No old image to remove"
          echo "âœ… Cleanup complete"

      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“¥ Pull Latest Image from Docker Hub
        run: |
          echo "Pulling image from Docker Hub..."
          docker pull xxfall3nxx/mara-command-center:latest
          echo "âœ… Image pulled successfully"

      - name: ğŸš€ Deploy Container
        run: |
          echo "Starting new container on port 3001..."
          docker run -d \
            --restart unless-stopped \
            -p 3001:3001 \
            --env NODE_ENV=production \
            --env AWS_REGION=${{ secrets.AWS_REGION }} \
            --env AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            --env AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            --name mara-command \
            xxfall3nxx/mara-command-center:latest
          echo "âœ… Container started"

      - name: ğŸ¥ Health Check
        run: |
          echo "Waiting for application to start..."
          sleep 10
          echo "Checking container status..."
          docker ps | grep mara-command
          echo "Testing HTTP endpoint..."
          curl -f http://localhost:3001 || exit 1
          echo "âœ… Dashboard is live at https://mara.trendlydigital.com"
