name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Stop existing container
        run: |
          echo "ğŸ›‘ Stopping existing container..."
          docker stop mara-command 2>/dev/null || echo "No existing container"
          docker rm mara-command 2>/dev/null || echo "No container to remove"
          echo "âœ… Cleanup complete"
      
      - name: Build Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build -t mara-command-center:latest .
          echo "âœ… Build complete"
      
      - name: Deploy container
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "ğŸš€ Starting container..."
          docker run -d \
            --name mara-command \
            -p 3001:3001 \
            --restart unless-stopped \
            -e NODE_ENV=production \
            -e AWS_REGION=us-east-1 \
            -e AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \
            -e AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \
            mara-command-center:latest
          echo "â³ Waiting for container to start..."
          sleep 5
          echo "âœ… Container started"
      
      - name: Health check
        run: |
          echo "ğŸ¥ Checking container health..."
          docker ps | grep mara-command && echo "âœ… Container is running!" || (echo "âŒ Container failed to start" && exit 1)
          echo "ğŸ“Š Container logs:"
          docker logs mara-command --tail 20
      
      - name: Verify deployment
        run: |
          echo "ğŸ‰ Deployment complete!"
          echo "ğŸ“ Dashboard: https://mara.trendlydigital.com"
