name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Build and Deploy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Stop existing container
          docker stop mara-command 2>/dev/null || true
          docker rm mara-command 2>/dev/null || true
          
          # Build new image
          docker build -t mara-command-center:latest .
          
          # Run container
          docker run -d \
            --name mara-command \
            -p 3001:3001 \
            --restart unless-stopped \
            -e NODE_ENV=production \
            -e AWS_REGION=us-east-1 \
            -e AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \
            -e AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \
            mara-command-center:latest
          
          # Wait and check
          sleep 5
          docker ps | grep mara-command && echo "‚úÖ Deployment successful!" || echo "‚ùå Deployment failed"
      
      - name: Verify deployment
        run: |
          echo "üéâ Deployment complete!"
          echo "üìç Dashboard: https://mara.trendlydigital.com"
